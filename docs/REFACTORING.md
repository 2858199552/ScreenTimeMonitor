# 主进程重构文档

## 📋 重构概述

本次重构将原来800+行的单一主进程文件拆分为模块化架构，提升代码可维护性、可测试性和可扩展性。

### 重构目标
- ✅ 解决表情符号显示兼容性问题
- ✅ 实现彩色日志系统
- ✅ 将单体代码拆分为模块化架构
- ✅ 提升代码可维护性
- ✅ 增强系统稳定性

### 重构时间
- 开始时间：2025年7月19日
- 完成时间：2025年7月19日
- 重构版本：v2.0.0

---

## 🏗️ 架构变化

### 重构前架构
```
src/main/
└── index.js (单文件 ~800 行)
    ├── 应用检测逻辑
    ├── 数据存储逻辑
    ├── 自动保存逻辑
    ├── 窗口管理逻辑
    ├── IPC通信处理
    ├── 托盘管理
    └── 应用生命周期管理
```

### 重构后架构
```
src/main/
├── index.js (主入口文件 ~120 行)
├── utils/
│   └── logger.js (日志工具模块)
└── modules/
    ├── appDetector.js (应用检测模块)
    ├── dataStorage.js (数据存储模块)
    ├── autoSaver.js (自动保存模块)
    ├── windowManager.js (窗口管理模块)
    └── ipcHandler.js (IPC通信模块)
```

---

## 📁 模块详细说明

### 1. 主入口文件 (`index.js`)
**职责：** 应用启动、模块初始化、生命周期管理

**核心功能：**
- 模块实例化和依赖注入
- 应用生命周期事件处理
- 多实例防护
- 优雅退出处理

**关键方法：**
```javascript
initializeApp()     // 初始化所有模块
cleanupBeforeQuit() // 退出前清理工作
```

### 2. 日志工具模块 (`utils/logger.js`)
**职责：** 统一的彩色日志输出系统

**特性：**
- 兼容性强的ASCII符号（替代表情符号）
- 彩色输出（绿色成功、红色错误、黄色警告等）
- 统一的日志格式

**API：**
```javascript
Logger.success(message)  // 成功日志 - 绿色
Logger.error(message)    // 错误日志 - 红色  
Logger.warning(message)  // 警告日志 - 黄色
Logger.info(message)     // 信息日志 - 青色
Logger.save(message)     // 保存日志 - 绿色
Logger.start(message)    // 启动日志 - 绿色
Logger.stop(message)     // 停止日志 - 黄色
Logger.quit(message)     // 退出日志 - 青色
```

### 3. 应用检测模块 (`modules/appDetector.js`)
**职责：** 检测和管理活跃应用程序

**核心功能：**
- 活跃窗口检测
- 自身应用排除
- 使用时间统计
- 应用信息清理
- 应用名称标准化

**主要方法：**
```javascript
async getRunningApps()           // 获取运行中的应用
isSelfApplication(window)        // 判断是否为自身应用
getCleanAppName(name)           // 清理应用名称
formatUsageTime(seconds)        // 格式化使用时间
getUsageData()                  // 获取使用数据供保存
```

### 4. 数据存储模块 (`modules/dataStorage.js`)
**职责：** 应用数据的持久化存储

**核心功能：**
- JSON文件存储
- 自动备份机制
- 默认数据生成
- 数据路径管理

**主要方法：**
```javascript
async loadData()                // 加载数据
async saveData(data)           // 保存数据
getDefaultData()               // 获取默认数据
generateDayData(dayOffset)     // 生成单日数据
getDataInfo()                  // 获取存储路径信息
```

### 5. 自动保存模块 (`modules/autoSaver.js`)
**职责：** 定时自动保存应用使用数据

**核心功能：**
- 定时保存机制
- 保存状态管理
- 间隔时间配置
- 手动保存支持

**主要方法：**
```javascript
async saveUsageData()          // 执行保存操作
start()                        // 启动自动保存
stop()                         // 停止自动保存
getStatus()                    // 获取保存状态
setInterval(minutes)           // 设置保存间隔
```

### 6. 窗口管理模块 (`modules/windowManager.js`)
**职责：** 主窗口和系统托盘管理

**核心功能：**
- 主窗口创建和管理
- 系统托盘功能
- 窗口控制（最小化、最大化、隐藏）
- 开机自启管理
- 系统通知

**主要方法：**
```javascript
createWindow()                 // 创建主窗口
createTray()                   // 创建系统托盘
minimize()                     // 最小化窗口
maximize()                     // 最大化窗口
hide()                         // 隐藏窗口
showNotification(title, body)  // 显示通知
setAutoStart(enable)           // 设置开机自启
```

### 7. IPC通信模块 (`modules/ipcHandler.js`)
**职责：** 主进程与渲染进程的通信处理

**核心功能：**
- IPC处理器注册
- 数据查询接口
- 设置管理接口
- 窗口控制接口
- 自动保存接口

**主要接口：**
```javascript
// 应用数据
'get-running-apps'             // 获取运行应用
'get-app-usage'               // 获取使用数据
'save-app-usage'              // 保存使用数据

// 自动保存
'save-current-usage'          // 手动保存
'get-auto-save-status'        // 获取保存状态

// 窗口控制
'minimize-window'             // 最小化窗口
'maximize-window'             // 最大化窗口
'close-window'                // 关闭窗口

// 设置管理
'get-settings'                // 获取设置
'save-settings'               // 保存设置
```

---

## 🎯 重构优势

### 1. 代码组织
- **单一职责原则**：每个模块专注特定功能
- **高内聚低耦合**：模块内部紧密相关，模块间依赖最小
- **清晰的边界**：明确的模块职责划分

### 2. 可维护性
- **易于定位问题**：按功能分模块，快速定位bug
- **独立修改**：修改某功能不影响其他模块
- **代码复用**：模块可在不同场景下复用

### 3. 可测试性
- **单元测试友好**：每个模块可独立测试
- **模拟依赖容易**：通过依赖注入轻松模拟
- **测试覆盖率提升**：小模块更容易达到完整覆盖

### 4. 可扩展性
- **新功能添加简单**：新增模块不影响现有代码
- **配置灵活**：模块参数化配置
- **插件化架构**：为将来插件系统打基础

### 5. 开发体验
- **IDE友好**：更好的代码补全和错误提示
- **Git协作**：多人开发冲突减少
- **调试便利**：问题定位更精确

---

## 🔧 使用指南

### 开发环境启动
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 查看日志输出
# 绿色 [SUCCESS] - 成功操作
# 红色 [ERROR] - 错误信息
# 黄色 [WARNING] - 警告信息
# 青色 [INFO] - 普通信息
```

### 添加新功能模块
1. 在 `src/main/modules/` 创建新模块文件
2. 实现模块类和导出
3. 在 `index.js` 中导入和初始化
4. 在 `ipcHandler.js` 中添加相关IPC接口

### 修改现有功能
1. 找到对应的模块文件
2. 修改具体实现
3. 更新相关的类型定义或接口
4. 测试功能是否正常

---

## 📊 性能优化

### 内存管理
- 模块化减少了全局变量的使用
- 明确的生命周期管理
- 及时清理过期数据和定时器

### 启动性能
- 延迟加载非核心模块
- 按需初始化功能
- 优化模块依赖关系

### 运行时性能
- 缓存机制优化
- 定时器合理配置
- 减少不必要的计算

---

## 🛠️ 维护指南

### 日常维护
1. **日志监控**：关注终端彩色日志输出
2. **模块状态**：定期检查各模块工作状态
3. **数据备份**：确保数据存储和备份机制正常

### 问题排查
1. **查看日志**：根据颜色编码快速识别问题类型
2. **模块隔离**：逐个检查模块功能
3. **依赖检查**：确认模块间依赖正常

### 版本升级
1. **向后兼容**：确保数据格式兼容
2. **模块升级**：独立升级特定模块
3. **测试验证**：完整功能测试

---

## 🔍 故障排除

### 常见问题

#### 1. 日志显示异常
**症状：** 终端中看到乱码或表情符号
**解决：** 已使用ASCII符号替代，确保兼容性

#### 2. 模块加载失败
**症状：** 启动时出现模块导入错误
**解决：** 检查模块路径和导出语法

#### 3. 自动保存不工作
**症状：** 没有看到 `[SUCCESS] Auto-saved` 日志
**解决：** 检查AutoSaver模块状态和权限

#### 4. 应用检测异常
**症状：** 无法检测到活跃应用
**解决：** 检查active-win包版本和权限设置

### 调试技巧
1. **启用详细日志**：修改Logger输出级别
2. **模块状态检查**：添加状态输出
3. **断点调试**：在关键模块方法设置断点

---

## 📈 未来规划

### 短期计划 (1-2周)
- [ ] 添加单元测试
- [ ] 性能监控模块
- [ ] 配置文件支持

### 中期计划 (1-2月)
- [ ] 插件系统架构
- [ ] 国际化支持
- [ ] 更多应用分类

### 长期计划 (3-6月)
- [ ] 云同步功能
- [ ] 机器学习应用分析
- [ ] 跨平台优化

---

## 📝 变更记录

### v2.0.0 (2025-07-19)
- ✅ 完成主进程模块化重构
- ✅ 实现彩色日志系统
- ✅ 修复表情符号兼容性问题
- ✅ 优化代码结构和可维护性

### v1.x (历史版本)
- 单一文件架构
- 基础功能实现
- 表情符号日志（存在兼容性问题）

---

## 🤝 贡献指南

### 代码风格
- 使用ES6+语法
- 遵循单一职责原则
- 添加适当的注释和文档
- 使用有意义的变量和方法名

### 提交规范
```
feat: 新功能
fix: 修复bug
refactor: 重构
docs: 文档更新
test: 测试相关
style: 代码格式调整
```

### 开发流程
1. 创建功能分支
2. 实现功能并测试
3. 更新相关文档
4. 提交代码审查
5. 合并到主分支

---

## 📚 相关资源

### 技术文档
- [Electron官方文档](https://www.electronjs.org/docs)
- [Node.js模块系统](https://nodejs.org/api/modules.html)
- [active-win包文档](https://github.com/sindresorhus/active-win)

### 项目文档
- [项目README](../README.md)
- [API文档](./API.md)
- [部署指南](./DEPLOYMENT.md)

---

*本文档最后更新：2025年7月19日*
*维护者：GitHub Copilot*
